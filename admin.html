<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Administration - Association Mille Voiles</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 您的Supabase配置 -->
    <script src="supabase-config.js"></script>
   <style>
    :root {
        --primary-blue: #004080;
        --primary-light-blue: #0066cc;
        --primary-yellow: #ffd633;
        --primary-light-yellow: #ffe066;
        --dark-gray: #333333;
        --medium-gray: #666666;
        --light-gray: #f5f7fa;
        --white: #ffffff;
        --green: #27ae60;
        --orange: #f39c12;
        --red: #e74c3c;
        --purple: #8e44ad;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
    }

    html {
        overflow-x: hidden;
        width: 100%;
        height: 100%;
        scroll-behavior: smooth;
    }

    /* 关键修复：整个页面容器缩放 */
    body {
        font-family: 'Open Sans', sans-serif;
        color: var(--dark-gray);
        background-color: var(--light-gray);
        line-height: 1.7;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        -webkit-text-size-adjust: 100%;
        -moz-text-size-adjust: 100%;
        width: 100%;
        overflow-x: hidden;
        position: relative;
        margin: 0 auto;
    }

    /* 桌面端正常显示 */
    @media (min-width: 769px) {
        body {
            max-width: 100%;
        }
    }

    /* 手机端整体缩放 */
    @media (max-width: 768px) {
        body {
            transform: scale(0.8); /* 整体缩放为80% */
            transform-origin: top center;
            width: 125%; /* 反向补偿宽度 (100% / 0.8 = 125%) */
            min-height: 125vh; /* 补偿高度 */
            position: relative;
            left: -12.5%; /* 居中调整 (125% - 100%) / 2 = 12.5% */
        }
        
        /* 修复滚动条 */
        html {
            overflow-x: hidden;
        }
    }

    /* 更小的手机 */
    @media (max-width: 480px) {
        body {
            transform: scale(0.7); /* 整体缩放为70% */
            width: 142.86%; /* 100% / 0.7 */
            min-height: 142.86vh;
            left: -21.43%; /* (142.86% - 100%) / 2 */
        }
    }

    /* 超小手机 */
    @media (max-width: 360px) {
        body {
            transform: scale(0.6); /* 整体缩放为60% */
            width: 166.67%; /* 100% / 0.6 */
            min-height: 166.67vh;
            left: -33.33%; /* (166.67% - 100%) / 2 */
        }
    }

    h1, h2, h3, h4, h5 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        line-height: 1.3;
        color: var(--primary-blue);
    }

    .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        position: relative;
    }

    /* Header */
    .main-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-light-blue) 100%);
        color: var(--white);
        padding: 30px 0;
        text-align: center;
        box-shadow: var(--shadow);
        position: relative;
        width: 100%;
    }

    .main-header h1 {
        color: var(--white);
        font-size: 2.8rem;
        margin-bottom: 10px;
    }

    .main-header p {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 800px;
        margin: 0 auto;
    }

    /* Navigation */
    .main-nav {
        background-color: var(--white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 15px 0;
        text-align: center;
        width: 100%;
    }

    .back-home {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: var(--transition);
    }

    .back-home:hover {
        color: var(--primary-light-blue);
        transform: translateX(-5px);
    }

    /* 登录部分 - 确保在缩放后也能正常滚动 */
    .login-section {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px 20px;
        min-height: calc(100vh - 280px);
        width: 100%;
        position: relative;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* 修复缩放后的登录卡片 */
    @media (max-width: 768px) {
        .login-section {
            min-height: calc(125vh - 280px); /* 补偿缩放后的高度 */
        }
    }

    @media (max-width: 480px) {
        .login-section {
            min-height: calc(142.86vh - 280px);
        }
    }

    @media (max-width: 360px) {
        .login-section {
            min-height: calc(166.67vh - 280px);
        }
    }

    .login-card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 450px;
        text-align: center;
        margin: 20px auto;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
    }

    /* 移动端登录卡片适配 */
    @media (max-width: 768px) {
        .login-card {
            transform: none !important; /* 禁止内部再次缩放 */
            max-height: 100vh;
        }
    }

    .login-icon {
        font-size: 4rem;
        color: var(--primary-blue);
        margin-bottom: 20px;
    }

    .login-card h2 {
        margin-bottom: 15px;
        font-size: 2rem;
    }

    .login-card p {
        color: var(--medium-gray);
        margin-bottom: 30px;
        font-size: 1.1rem;
    }

    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-blue);
    }

    .form-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: 'Open Sans', sans-serif;
        font-size: 1rem;
        transition: var(--transition);
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1);
    }

    .error-message {
        color: var(--red);
        font-size: 0.9rem;
        margin-top: 5px;
        display: none;
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .login-btn {
        width: 100%;
        padding: 16px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }

    .login-btn:hover {
        background-color: var(--primary-light-blue);
        transform: translateY(-2px);
    }

    .login-btn:active {
        transform: translateY(0);
    }

    /* 管理员内容 - 添加滚动 */
    .admin-content {
        flex: 1;
        padding: 60px 0;
        display: none;
        width: 100%;
        position: relative;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* 控制面板 */
    .dashboard {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        box-shadow: var(--shadow);
        margin-bottom: 40px;
        width: 100%;
        position: relative;
        transform: none !important;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .dashboard-title {
        font-size: 2.2rem;
        position: relative;
    }

    .dashboard-title:after {
        content: '';
        position: absolute;
        width: 60px;
        height: 4px;
        background-color: var(--primary-yellow);
        bottom: -10px;
        left: 0;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        background: rgba(0, 64, 128, 0.05);
        padding: 15px 25px;
        border-radius: 50px;
    }

    .user-info i {
        color: var(--primary-blue);
        font-size: 1.5rem;
    }

    .logout-btn {
        background-color: var(--red);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
    }

    .logout-btn:hover {
        background-color: #c0392b;
    }

    /* 统计网格 - 更新为5列 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin-bottom: 40px;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(0, 64, 128, 0.05) 0%, rgba(0, 102, 204, 0.05) 100%);
        border-radius: var(--border-radius);
        padding: 25px;
        text-align: center;
        transition: var(--transition);
        transform: none !important;
    }

    .stat-card:hover {
        transform: translateY(-5px) !important;
        box-shadow: var(--shadow);
    }

    .stat-icon {
        font-size: 2.2rem;
        color: var(--primary-blue);
        margin-bottom: 15px;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }

    .stat-label {
        color: var(--medium-gray);
        font-size: 1rem;
        line-height: 1.4;
    }

    /* 用户管理表格 */
    .users-table-container {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        box-shadow: var(--shadow);
        margin-bottom: 40px;
        width: 100%;
        position: relative;
        transform: none !important;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .section-header {
        margin-bottom: 40px;
    }

    .section-header h2 {
        font-size: 2.2rem;
        margin-bottom: 15px;
        display: inline-block;
        position: relative;
    }

    .section-header h2:after {
        content: '';
        position: absolute;
        width: 60px;
        height: 4px;
        background-color: var(--primary-yellow);
        bottom: -10px;
        left: 0;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 500px;
    }

    .search-box input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: 'Open Sans', sans-serif;
    }

    .search-btn {
        padding: 12px 25px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
    }

    .search-btn:hover {
        background-color: var(--primary-light-blue);
    }

    .filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 10px 15px;
        background: var(--light-gray);
        border: 2px solid var(--primary-blue);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .filter-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    .filter-btn:hover:not(.active) {
        background: rgba(0, 64, 128, 0.1);
    }

    /* 表格样式 */
    .table-wrapper {
        overflow-x: auto;
        margin: 30px 0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        -webkit-overflow-scrolling: touch;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }

    .users-table th {
        background-color: var(--primary-blue);
        color: var(--white);
        font-weight: 600;
        padding: 18px 15px;
        text-align: left;
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 1rem;
    }

    .users-table td {
        padding: 15px;
        border: 1px solid #eee;
        vertical-align: middle;
        font-size: 0.95rem;
    }

    .users-table tr:nth-child(even) {
        background-color: rgba(0, 64, 128, 0.02);
    }

    .users-table tr:hover {
        background-color: rgba(0, 64, 128, 0.05);
    }

    .user-type {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .type-m { background-color: rgba(52, 152, 219, 0.1); color: #3498db; }
    .type-n { background-color: rgba(46, 204, 113, 0.1); color: #2ecc71; }
    .type-r { background-color: rgba(155, 89, 182, 0.1); color: #9b59b6; }
    .type-t { background-color: rgba(241, 196, 15, 0.1); color: #f1c40f; }

    .role-tag {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .role-admin { background-color: rgba(231, 76, 60, 0.1); color: var(--red); }
    .role-user { background-color: rgba(52, 152, 219, 0.1); color: #3498db; }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .edit-btn {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    .edit-btn:hover {
        background-color: rgba(52, 152, 219, 0.2);
    }

    .delete-btn {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--red);
    }

    .delete-btn:hover {
        background-color: rgba(231, 76, 60, 0.2);
    }

    /* 模态框 */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        width: 90%;
        max-width: 600px;
        box-shadow: var(--shadow);
        position: relative;
        animation: slideUp 0.3s;
        transform: none !important;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .modal-title {
        font-size: 1.8rem;
        color: var(--primary-blue);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--medium-gray);
        cursor: pointer;
        transition: var(--transition);
    }

    .close-btn:hover {
        color: var(--red);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-full {
        grid-column: 1 / -1;
    }

    .form-group select {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: 'Open Sans', sans-serif;
        background-color: white;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
    }

    .cancel-btn {
        padding: 12px 25px;
        background-color: var(--light-gray);
        color: var(--dark-gray);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .cancel-btn:hover {
        background-color: #e0e0e0;
    }

    .save-btn {
        padding: 12px 25px;
        background-color: var(--green);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .save-btn:hover {
        background-color: #219653;
    }

    /* 加载状态 */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--medium-gray);
    }

    .loading i {
        font-size: 2rem;
        margin-bottom: 15px;
        color: var(--primary-blue);
    }

    /* 消息提示 */
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow);
        animation: slideInRight 0.3s;
        transform: none !important;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .toast-success {
        background-color: var(--green);
    }

    .toast-error {
        background-color: var(--red);
    }

    .toast-warning {
        background-color: var(--orange);
    }

    /* 确认对话框 */
    .confirm-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .confirm-content {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow);
        text-align: center;
        transform: none !important;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .confirm-content h3 {
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .confirm-content p {
        margin-bottom: 30px;
        color: var(--medium-gray);
    }

    .confirm-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .confirm-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .confirm-cancel {
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }

    .confirm-cancel:hover {
        background-color: #e0e0e0;
    }

    .confirm-delete {
        background-color: var(--red);
        color: white;
    }

    .confirm-delete:hover {
        background-color: #c0392b;
    }

    /* Footer */
    .main-footer {
        background-color: var(--primary-blue);
        color: var(--white);
        padding: 30px 0;
        margin-top: auto;
        width: 100%;
        text-align: center;
    }

    .footer-bottom {
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.9rem;
        opacity: 0.7;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .main-header h1 {
            font-size: 2.2rem;
        }
        
        .main-header p {
            font-size: 1rem;
            padding: 0 10px;
        }
        
        .login-section {
            padding: 20px 15px;
            align-items: flex-start;
        }
        
        .login-card {
            padding: 25px 20px;
            margin: 10px auto;
            max-height: 85vh;
        }
        
        .login-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .login-card h2 {
            font-size: 1.6rem;
        }
        
        .form-group input {
            padding: 14px;
            font-size: 16px !important;
        }
        
        .login-btn {
            padding: 14px;
            min-height: 50px;
        }
        
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .user-info {
            align-self: flex-start;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            max-width: 100%;
        }
        
        .filters {
            justify-content: center;
        }
        
        .dashboard, .users-table-container {
            padding: 25px;
        }
        
        .modal-content {
            padding: 25px;
            width: 95%;
            max-height: 85vh;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .confirm-content {
            max-height: 85vh;
        }
    }

    @media (max-width: 480px) {
        .main-header h1 {
            font-size: 1.8rem;
        }
        
        .login-card {
            padding: 20px 15px;
            margin: 5px auto;
            max-height: 80vh;
        }
        
        .login-icon {
            font-size: 2.5rem;
        }
        
        .login-card h2 {
            font-size: 1.4rem;
        }
        
        .dashboard-title {
            font-size: 1.8rem;
        }
        
        .section-header h2 {
            font-size: 1.8rem;
        }
        
        .modal-content {
            padding: 20px 15px;
            max-height: 80vh;
        }
        
        .confirm-content {
            max-height: 80vh;
        }
    }

    /* 过期状态样式 */
    .expired {
        color: var(--red) !important;
        font-weight: bold;
    }
    
    .warning {
        color: var(--orange) !important;
        font-weight: bold;
    }
    
    .active {
        color: var(--green) !important;
    }

    /* 修复缩放后元素溢出问题 */
    .login-card,
    .dashboard,
    .users-table-container,
    .stat-card,
    .modal-content,
    .confirm-content,
    .toast {
        transform: none !important;
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light-blue);
    }
</style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <h1>Administration des utilisateurs</h1>
            <p>Association Mille Voiles - Gestion des comptes étudiants et administrateurs</p>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container">
            <a href="index.html" class="back-home">
                <i class="fas fa-arrow-left"></i> Retour à l'accueil
            </a>
        </div>
    </nav>

    <!-- 登录部分 -->
    <section class="login-section" id="loginSection">
        <div class="login-card">
            <div class="login-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2>Accès administration</h2>
            <p>Veuillez vous connecter en tant qu'administrateur pour accéder au panneau de gestion</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminUsername"><i class="fas fa-user"></i> Nom d'utilisateur admin</label>
                    <input type="text" id="adminUsername" placeholder="Entrez votre nom d'utilisateur" required>
                    <div class="error-message" id="usernameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="adminPassword"><i class="fas fa-lock"></i> Mot de passe admin</label>
                    <input type="password" id="adminPassword" placeholder="Entrez votre mot de passe" required>
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
            </form>
        </div>
    </section>

    <!-- 管理员内容 -->
    <main class="admin-content" id="adminContent">
        <div class="container">
            <!-- 控制面板 -->
            <section class="dashboard">
                <div class="dashboard-header">
                    <div>
                        <h1 class="dashboard-title">Tableau de bord administrateur</h1>
                        <p>Gérez les utilisateurs et les paramètres de l'application</p>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="user-info">
                            <i class="fas fa-user-circle"></i>
                            <div>
                                <div id="currentAdminName">Administrateur</div>
                                <div style="font-size: 0.9rem; color: var(--medium-gray);" id="currentAdminRole">Rôle: Admin</div>
                            </div>
                        </div>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Déconnexion
                        </button>
                    </div>
                </div>

                <!-- 统计部分 - 按照您的要求修改 -->
                <div class="stats-grid">
                    <!-- 总用户数 -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Utilisateurs totaux</div>
                    </div>
                    
                    <!-- Type N - 入籍学员 -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-passport"></i>
                        </div>
                        <div class="stat-number" id="typeNCount">0</div>
                        <div class="stat-label">Type N<br>入籍学员</div>
                    </div>
                    
                    <!-- Type R - 十年卡学员 -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-number" id="typeRCount">0</div>
                        <div class="stat-label">Type R<br>十年卡学员</div>
                    </div>
                    
                    <!-- Type M - 多年卡学员 -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-id-card-alt"></i>
                        </div>
                        <div class="stat-number" id="typeMCount">0</div>
                        <div class="stat-label">Type M<br>多年卡学员</div>
                    </div>
                    
                    <!-- Type T - 其他类型 -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-tag"></i>
                        </div>
                        <div class="stat-number" id="typeTCount">0</div>
                        <div class="stat-label">Type T<br>其他类型</div>
                    </div>
                </div>
            </section>

            <!-- 用户管理表格 -->
            <section class="users-table-container">
                <div class="section-header">
                    <h2>Gestion des utilisateurs</h2>
                    <p>Visualisez, modifiez et gérez tous les utilisateurs de l'application</p>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Rechercher un utilisateur par nom...">
                        <button class="search-btn" id="searchBtn">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                    
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">Tous</button>
                        <button class="filter-btn" data-filter="type-n">Type N (入籍)</button>
                        <button class="filter-btn" data-filter="type-r">Type R (十年卡)</button>
                        <button class="filter-btn" data-filter="type-m">Type M (多年卡)</button>
                        <button class="filter-btn" data-filter="type-t">Type T</button>
                        <button class="filter-btn" data-filter="admin">Administrateurs</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Type</th>
                                <th>Rôle</th>
                                <th>Date de création</th>
                                <th>Date d'expiration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Les données seront chargées ici via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="loading" id="tableLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Chargement des données...</p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="login-btn" id="addUserBtn" style="width: auto; padding: 12px 30px;">
                        <i class="fas fa-user-plus"></i> Ajouter un nouvel utilisateur
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- 编辑用户模态框 -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modifier l'utilisateur</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUserName">Nom d'utilisateur</label>
                        <input type="text" id="editUserName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserPassword">Mot de passe (laisser vide pour ne pas changer)</label>
                        <input type="password" id="editUserPassword" placeholder="Nouveau mot de passe">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editUserType">Type d'utilisateur</label>
                        <select id="editUserType" required>
                            <option value="n">Type N (入籍学员)</option>
                            <option value="r">Type R (十年卡学员)</option>
                            <option value="m">Type M (多年卡学员)</option>
                            <option value="t">Type T (其他类型)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserRole">Rôle</label>
                        <select id="editUserRole">
                            <option value="">Pas de rôle</option>
                            <option value="user">Utilisateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group form-full">
                    <label>Date de création</label>
                    <div style="padding: 15px; background: var(--light-gray); border-radius: 8px;" id="editUserCreatedAt">
                        Chargement...
                    </div>
                </div>

                <div class="form-group form-full">
                    <label>Date d'expiration (facultatif)</label>
                    <input type="datetime-local" id="editUserTimer">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelEditBtn">Annuler</button>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter un nouvel utilisateur</h2>
                <button class="close-btn" id="closeAddModalBtn">&times;</button>
            </div>
            
            <form id="addUserForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="addUserName">Nom d'utilisateur</label>
                        <input type="text" id="addUserName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addUserPassword">Mot de passe</label>
                        <input type="password" id="addUserPassword" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="addUserType">Type d'utilisateur</label>
                        <select id="addUserType" required>
                            <option value="n">Type N (入籍学员)</option>
                            <option value="r">Type R (十年卡学员)</option>
                            <option value="m">Type M (多年卡学员)</option>
                            <option value="t">Type T (其他类型)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addUserRole">Rôle (facultatif)</label>
                        <select id="addUserRole">
                            <option value="">Pas de rôle</option>
                            <option value="user">Utilisateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                </div>

                <div class="form-group form-full">
                    <label>Date d'expiration (facultatif)</label>
                    <input type="datetime-local" id="addUserTimer">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelAddBtn">Annuler</button>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-user-plus"></i> Créer l'utilisateur
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 确认删除对话框 -->
    <div class="confirm-dialog" id="deleteConfirmDialog">
        <div class="confirm-content">
            <h3><i class="fas fa-exclamation-triangle" style="color: var(--red); margin-right: 10px;"></i> Confirmer la suppression</h3>
            <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong id="deleteUserName">Nom</strong> ? Cette action est irréversible.</p>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-cancel" id="cancelDeleteBtn">Annuler</button>
                <button class="confirm-btn confirm-delete" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Supprimer définitivement
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Association Mille Voiles - Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script>
        // ==============================
        // 管理后台核心逻辑
        // ==============================
        
        console.log('管理后台初始化...');
        
        // 检查supabaseAuth是否已加载
        if (typeof window.supabaseAuth === 'undefined') {
            console.error('错误: supabase-config.js 未加载');
            alert('系统配置加载失败，请刷新页面重试');
        }

        // ==============================
        // DOM 元素引用
        // ==============================
        const loginSection = document.getElementById('loginSection');
        const adminContent = document.getElementById('adminContent');
        const loginForm = document.getElementById('loginForm');
        const usersTableBody = document.getElementById('usersTableBody');
        const tableLoading = document.getElementById('tableLoading');
        const editUserModal = document.getElementById('editUserModal');
        const addUserModal = document.getElementById('addUserModal');
        const editUserForm = document.getElementById('editUserForm');
        const addUserForm = document.getElementById('addUserForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const deleteConfirmDialog = document.getElementById('deleteConfirmDialog');
        
        // 搜索和过滤元素
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const addUserBtn = document.getElementById('addUserBtn');
        
        // 统计数据元素 - 现在有5个统计项
        const totalUsersEl = document.getElementById('totalUsers');
        const typeNCountEl = document.getElementById('typeNCount'); // Type N - 入籍学员
        const typeRCountEl = document.getElementById('typeRCount'); // Type R - 十年卡学员
        const typeMCountEl = document.getElementById('typeMCount'); // Type M - 多年卡学员
        const typeTCountEl = document.getElementById('typeTCount'); // Type T - 其他类型
        const currentAdminNameEl = document.getElementById('currentAdminName');
        const currentAdminRoleEl = document.getElementById('currentAdminRole');
        
        // ==============================
        // 全局变量
        // ==============================
        let currentAdmin = null;
        let allUsers = [];
        let filteredUsers = [];
        let currentFilter = 'all';
        let userToDelete = null;

        // ==============================
        // 页面加载初始化
        // ==============================
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            checkAdminSession();
        });

        // ==============================
        // 初始化事件监听器
        // ==============================
        function initEventListeners() {
            // 登录表单提交
            loginForm.addEventListener('submit', handleAdminLogin);
            
            // 登出按钮
            logoutBtn.addEventListener('click', handleLogout);
            
            // 搜索功能
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') handleSearch();
            });
            
            // 过滤按钮
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    applyFilters();
                });
            });
            
            // 添加用户按钮
            addUserBtn.addEventListener('click', showAddUserModal);
            
            // 模态框关闭按钮
            document.getElementById('closeModalBtn').addEventListener('click', () => closeModal(editUserModal));
            document.getElementById('closeAddModalBtn').addEventListener('click', () => closeModal(addUserModal));
            document.getElementById('cancelEditBtn').addEventListener('click', () => closeModal(editUserModal));
            document.getElementById('cancelAddBtn').addEventListener('click', () => closeModal(addUserModal));
            
            // 表单提交
            editUserForm.addEventListener('submit', handleEditUser);
            addUserForm.addEventListener('submit', handleAddUser);
            
            // 确认删除对话框
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal(deleteConfirmDialog));
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteUser);
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === editUserModal) closeModal(editUserModal);
                if (e.target === addUserModal) closeModal(addUserModal);
                if (e.target === deleteConfirmDialog) closeModal(deleteConfirmDialog);
            });
        }

        // ==============================
        // 会话管理
        // ==============================
        function checkAdminSession() {
            try {
                const savedAdmin = localStorage.getItem('adminUser');
                if (savedAdmin) {
                    const admin = JSON.parse(savedAdmin);
                    if (admin && admin.name && admin.role === 'admin') {
                        currentAdmin = admin;
                        showAdminContent();
                        loadUsers();
                    } else {
                        localStorage.removeItem('adminUser');
                    }
                }
            } catch (e) {
                localStorage.removeItem('adminUser');
                console.error('会话检查错误:', e);
            }
        }

        // ==============================
        // 登录功能
        // ==============================
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const usernameError = document.getElementById('usernameError');
            const passwordError = document.getElementById('passwordError');
            
            // 重置错误信息
            usernameError.style.display = 'none';
            passwordError.style.display = 'none';
            
            try {
                // 使用supabaseAuth验证用户
                const studentData = await window.supabaseAuth.validateStudent(username, password);
                
                if (!studentData) {
                    usernameError.textContent = "Nom d'utilisateur ou mot de passe incorrect";
                    usernameError.style.display = 'block';
                    return;
                }
                
                // 检查是否是管理员
                if (studentData.role !== 'admin') {
                    passwordError.textContent = "Accès refusé: Cet utilisateur n'est pas administrateur";
                    passwordError.style.display = 'block';
                    return;
                }
                
                // 检查访问权限
                const access = window.supabaseAuth.checkAccess(studentData);
                if (!access.valid) {
                    passwordError.textContent = access.message || "Votre compte a expiré";
                    passwordError.style.display = 'block';
                    return;
                }
                
                // 登录成功
                currentAdmin = {
                    id: studentData.id,
                    name: studentData.name,
                    role: studentData.role,
                    type: studentData.type,
                    timer: studentData.timer
                };
                
                // 保存到本地存储
                localStorage.setItem('adminUser', JSON.stringify(currentAdmin));
                
                // 显示管理界面
                showAdminContent();
                loadUsers();
                showToast('Connexion réussie!', 'success');
                
            } catch (error) {
                console.error('登录错误:', error);
                usernameError.textContent = "Une erreur s'est produite. Veuillez réessayer.";
                usernameError.style.display = 'block';
            }
        }

        // ==============================
        // 显示/隐藏界面
        // ==============================
        function showAdminContent() {
            loginSection.style.display = 'none';
            adminContent.style.display = 'block';
            
            // 更新当前管理员信息
            if (currentAdmin) {
                currentAdminNameEl.textContent = currentAdmin.name;
                currentAdminRoleEl.textContent = `Rôle: ${currentAdmin.role === 'admin' ? 'Administrateur' : currentAdmin.role || 'Utilisateur'}`;
            }
        }

        function showLoginContent() {
            loginSection.style.display = 'flex';
            adminContent.style.display = 'none';
            loginForm.reset();
        }

        // ==============================
        // 用户管理功能
        // ==============================
        async function loadUsers() {
            showLoading(true);
            
            try {
                const supabase = window.supabaseAuth.getSupabaseClient();
                
                // 从 Supabase 获取所有用户
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allUsers = data || [];
                filteredUsers = [...allUsers];
                
                // 更新统计数据
                updateStats();
                
                // 渲染表格
                renderUsersTable();
                
                showLoading(false);
                
            } catch (error) {
                console.error('加载用户错误:', error);
                showToast('Erreur lors du chargement des utilisateurs', 'error');
                showLoading(false);
            }
        }

        function renderUsersTable() {
            if (filteredUsers.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-users" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                            <p style="color: var(--medium-gray);">Aucun utilisateur trouvé</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            usersTableBody.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // 格式化日期
                const createdAt = user.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'N/A';
                
                // 检查过期时间并格式化
                let timerInfo = 'Pas de date';
                let timerClass = '';
                if (user.timer) {
                    const timerDate = new Date(user.timer);
                    const now = new Date();
                    
                    if (timerDate < now) {
                        timerInfo = `Expiré le ${timerDate.toLocaleDateString('fr-FR')}`;
                        timerClass = 'expired';
                    } else {
                        const timeDiff = timerDate - now;
                        const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                        timerInfo = `${timerDate.toLocaleDateString('fr-FR')} (${daysLeft} jours restants)`;
                        timerClass = daysLeft <= 7 ? 'warning' : 'active';
                    }
                }
                
                // 确定类型标签
                let typeClass = '';
                let typeText = '';
                switch(user.type) {
                    case 'n': typeClass = 'type-n'; typeText = 'Type N (入籍)'; break;
                    case 'r': typeClass = 'type-r'; typeText = 'Type R (十年卡)'; break;
                    case 'm': typeClass = 'type-m'; typeText = 'Type M (多年卡)'; break;
                    case 't': typeClass = 'type-t'; typeText = 'Type T'; break;
                    default: typeClass = 'type-t'; typeText = 'Type T';
                }
                
                // 确定角色标签
                let roleClass = '';
                let roleText = '';
                if (user.role === 'admin') {
                    roleClass = 'role-admin';
                    roleText = 'Administrateur';
                } else if (user.role === 'user') {
                    roleClass = 'role-user';
                    roleText = 'Utilisateur';
                } else {
                    roleClass = '';
                    roleText = '';
                }
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td><strong>${user.name}</strong></td>
                    <td><span class="user-type ${typeClass}">${typeText}</span></td>
                    <td>${roleText ? `<span class="role-tag ${roleClass}">${roleText}</span>` : ''}</td>
                    <td>${createdAt}</td>
                    <td class="${timerClass}">${timerInfo}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-id="${user.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="action-btn delete-btn" data-id="${user.id}" ${user.role === 'admin' && user.id === currentAdmin?.id ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            // 添加事件监听器到操作按钮
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.dataset.id;
                    openEditUserModal(userId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', function() {
                        const userId = this.dataset.id;
                        showDeleteConfirmation(userId);
                    });
                }
            });
        }

        // ==============================
        // 统计功能 - 按照您的要求修改
        // ==============================
        function updateStats() {
            const total = allUsers.length;
            const typeN = allUsers.filter(u => u.type === 'n').length; // Type N - 入籍学员
            const typeR = allUsers.filter(u => u.type === 'r').length; // Type R - 十年卡学员
            const typeM = allUsers.filter(u => u.type === 'm').length; // Type M - 多年卡学员
            const typeT = allUsers.filter(u => u.type === 't').length; // Type T - 其他类型
            
            totalUsersEl.textContent = total;
            typeNCountEl.textContent = typeN;
            typeRCountEl.textContent = typeR;
            typeMCountEl.textContent = typeM;
            typeTCountEl.textContent = typeT;
        }

        // ==============================
        // 搜索和过滤
        // ==============================
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            applyFilters(searchTerm);
        }

        function applyFilters(searchTerm = '') {
            filteredUsers = allUsers.filter(user => {
                // 应用搜索过滤
                if (searchTerm && !user.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // 应用类型过滤
                if (currentFilter !== 'all') {
                    if (currentFilter === 'admin') {
                        return user.role === 'admin';
                    } else {
                        const type = currentFilter.split('-')[1];
                        return user.type === type;
                    }
                }
                
                return true;
            });
            
            renderUsersTable();
        }

        // ==============================
        // 用户编辑功能
        // ==============================
        function openEditUserModal(userId) {
            const user = allUsers.find(u => u.id.toString() === userId.toString());
            if (!user) return;
            
            // 填充表单数据
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserType').value = user.type || 'n';
            document.getElementById('editUserRole').value = user.role || '';
            
            // 格式化创建日期
            const createdAt = user.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Date non disponible';
            document.getElementById('editUserCreatedAt').textContent = createdAt;
            
            // 设置过期日期
            if (user.timer) {
                const timerDate = new Date(user.timer);
                const localDate = new Date(timerDate.getTime() - (timerDate.getTimezoneOffset() * 60000))
                    .toISOString()
                    .slice(0, 16);
                document.getElementById('editUserTimer').value = localDate;
            } else {
                document.getElementById('editUserTimer').value = '';
            }
            
            // 更新模态框标题
            document.getElementById('modalTitle').textContent = `Modifier ${user.name}`;
            
            // 显示模态框
            editUserModal.style.display = 'flex';
        }

        async function handleEditUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const username = document.getElementById('editUserName').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const userType = document.getElementById('editUserType').value;
            const userRole = document.getElementById('editUserRole').value;
            const timer = document.getElementById('editUserTimer').value;
            
            // 验证输入
            if (!username || !userType) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            // 准备更新数据
            const updateData = {
                name: username,
                type: userType
            };
            
            // 如果提供了新密码，则更新
            if (password.trim()) {
                updateData.password = password;
            }
            
            // 处理role字段
            if (userRole) {
                updateData.role = userRole;
            } else {
                updateData.role = null; // 清除role字段
            }
            
            // 处理timer字段
            if (timer) {
                try {
                    const date = new Date(timer);
                    if (isNaN(date.getTime())) {
                        throw new Error('Date invalide');
                    }
                    updateData.timer = date.toISOString();
                } catch (error) {
                    console.warn('日期格式错误，跳过timer字段');
                }
            } else {
                updateData.timer = null; // 清除timer字段
            }
            
            try {
                const supabase = window.supabaseAuth.getSupabaseClient();
                
                console.log('更新用户数据:', updateData);
                
                // 更新用户数据
                const { error } = await supabase
                    .from('students')
                    .update(updateData)
                    .eq('id', userId);
                
                if (error) throw error;
                
                // 关闭模态框
                closeModal(editUserModal);
                
                // 重新加载用户数据
                await loadUsers();
                
                // 显示成功消息
                showToast('Utilisateur modifié avec succès', 'success');
                
            } catch (error) {
                console.error('修改用户错误:', error);
                
                let errorMessage = 'Erreur lors de la modification de l\'utilisateur';
                if (error.code === '23505') {
                    errorMessage = 'Ce nom d\'utilisateur existe déjà';
                } else if (error.code === '23514') {
                    errorMessage = 'Type d\'utilisateur invalide';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // ==============================
        // 添加用户功能
        // ==============================
        function showAddUserModal() {
            addUserForm.reset();
            document.getElementById('addUserType').value = 'n';
            document.getElementById('addUserRole').value = '';
            document.getElementById('addUserTimer').value = '';
            addUserModal.style.display = 'flex';
        }

        async function handleAddUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('addUserName').value.trim();
            const password = document.getElementById('addUserPassword').value;
            const userType = document.getElementById('addUserType').value;
            const userRole = document.getElementById('addUserRole').value;
            const timer = document.getElementById('addUserTimer').value;
            
            console.log('准备创建用户:', { username, userType, userRole, timer });
            
            // 验证输入
            if (!username || !password || !userType) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            // 验证type值是否有效
            const validTypes = ['n', 'r', 'm', 't'];
            if (!validTypes.includes(userType)) {
                showToast('Type d\'utilisateur invalide', 'error');
                return;
            }
            
            // 验证用户名是否已存在
            const existingUser = allUsers.find(u => u.name === username);
            if (existingUser) {
                showToast('Ce nom d\'utilisateur existe déjà', 'error');
                return;
            }
            
            // 准备新用户数据
            const newUser = {
                name: username,
                password: password,
                type: userType,
                created_at: new Date().toISOString()
            };
            
            // 添加role字段（如果提供）
            if (userRole) {
                newUser.role = userRole;
            }
            
            // 如果设置了过期时间，则添加
            if (timer) {
                try {
                    const date = new Date(timer);
                    if (isNaN(date.getTime())) {
                        throw new Error('Date invalide');
                    }
                    newUser.timer = date.toISOString();
                } catch (error) {
                    console.warn('日期格式错误，跳过timer字段');
                }
            }
            
            console.log('最终用户数据:', newUser);
            
            try {
                const supabase = window.supabaseAuth.getSupabaseClient();
                
                // 插入新用户
                const { data, error } = await supabase
                    .from('students')
                    .insert([newUser])
                    .select();
                    
                if (error) {
                    console.error('Supabase插入错误:', error);
                    
                    let errorMessage = 'Erreur lors de la création';
                    if (error.code === '23505') {
                        errorMessage = 'Ce nom d\'utilisateur existe déjà';
                    } else if (error.code === '23514') {
                        errorMessage = 'Type d\'utilisateur invalide';
                    } else if (error.message.includes('null value')) {
                        errorMessage = 'Champ obligatoire manquant';
                    }
                    
                    showToast(errorMessage, 'error');
                    return;
                }
                
                console.log('用户创建成功:', data);
                
                // 关闭模态框
                closeModal(addUserModal);
                
                // 重新加载用户数据
                await loadUsers();
                
                // 显示成功消息
                showToast('Utilisateur créé avec succès', 'success');
                
            } catch (error) {
                console.error('创建用户错误:', error);
                showToast('Erreur technique lors de la création', 'error');
            }
        }

        // ==============================
        // 删除用户功能
        // ==============================
        function showDeleteConfirmation(userId) {
            const user = allUsers.find(u => u.id.toString() === userId.toString());
            if (!user) return;
            
            userToDelete = user;
            document.getElementById('deleteUserName').textContent = user.name;
            deleteConfirmDialog.style.display = 'flex';
        }

        async function handleDeleteUser() {
            if (!userToDelete) return;
            
            try {
                const supabase = window.supabaseAuth.getSupabaseClient();
                
                // 从 Supabase 删除用户
                const { error } = await supabase
                    .from('students')
                    .delete()
                    .eq('id', userToDelete.id);
                
                if (error) throw error;
                
                // 关闭确认对话框
                closeModal(deleteConfirmDialog);
                
                // 重新加载用户数据
                await loadUsers();
                
                // 显示成功消息
                showToast('Utilisateur supprimé avec succès', 'success');
                
                // 重置要删除的用户
                userToDelete = null;
                
            } catch (error) {
                console.error('删除用户错误:', error);
                showToast('Erreur lors de la suppression de l\'utilisateur', 'error');
            }
        }

        // ==============================
        // 登出功能
        // ==============================
        function handleLogout() {
            localStorage.removeItem('adminUser');
            currentAdmin = null;
            allUsers = [];
            filteredUsers = [];
            showLoginContent();
            showToast('Vous avez été déconnecté', 'success');
        }

        // ==============================
        // 辅助函数
        // ==============================
        function showLoading(show) {
            tableLoading.style.display = show ? 'block' : 'none';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
        }

        function showToast(message, type = 'success') {
            // 移除已有的 toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            // 创建新的 toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideInRight 0.3s reverse';
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 300);
                }
            }, 3000);
        }

        // ==============================
        // 初始化完成
        // ==============================
        console.log('管理后台初始化完成');
    </script>
</body>
</html>