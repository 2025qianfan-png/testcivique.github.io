<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test des Valeurs de la République et Laïcité</title>
<!-- 添加Supabase库和配置文件 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Variables et reset */
:root {
  --primary-blue: #004080;
  --primary-light-blue: #0066cc;
  --primary-yellow: #ffd633;
  --primary-light-yellow: #ffe066;
  --dark-gray: #333333;
  --medium-gray: #666666;
  --light-gray: #f5f7fa;
  --white: #ffffff;
  --green: #27ae60;
  --red: #e74c3c;
  --orange: #f39c12;
  --purple: #9b59b6;
  --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
  --border-radius: 12px;
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Open Sans', sans-serif;
  color: var(--dark-gray);
  background-color: var(--light-gray);
  line-height: 1.7;
  overflow-x: hidden;
}

h1, h2, h3, h4 {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  line-height: 1.3;
  color: var(--primary-blue);
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.btn {
  display: inline-block;
  padding: 16px 36px;
  background-color: var(--primary-yellow);
  color: var(--primary-blue);
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  font-family: 'Montserrat', sans-serif;
  box-shadow: var(--shadow);
}

.btn:hover {
  background-color: var(--primary-light-yellow);
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.btn-primary {
  background-color: var(--primary-blue);
  color: var(--white);
}

.btn-primary:hover {
  background-color: var(--primary-light-blue);
}

.btn-success {
  background-color: var(--green);
  color: var(--white);
}

.btn-success:hover {
  background-color: #229954;
}

/* Custom Alert Modal */
.alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 4000;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.alert-content {
  background-color: var(--white);
  padding: 40px;
  border-radius: var(--border-radius);
  max-width: 600px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
  text-align: center;
}

@keyframes modalFade {
  from { opacity: 0; transform: translateY(-30px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.alert-icon.success {
  color: var(--green);
}

.alert-icon.warning {
  color: var(--orange);
}

.alert-icon.error {
  color: var(--red);
}

.alert-icon.info {
  color: var(--primary-blue);
}

.alert-content h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  color: var(--primary-blue);
}

.alert-content p {
  margin-bottom: 25px;
  color: var(--medium-gray);
  font-size: 1.1rem;
  line-height: 1.6;
}

.alert-btns {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

/* Login Modal */
.login-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  z-index: 3000;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  overflow-y: auto;
}

.login-content {
  background-color: var(--white);
  padding: 30px;
  border-radius: var(--border-radius);
  max-width: 500px;
  width: 100%;
  margin: 40px auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
}

.login-content h2 {
  font-size: 1.8rem;
  margin-bottom: 15px;
  color: var(--primary-blue);
  text-align: center;
}

.login-content p {
  margin-bottom: 20px;
  color: var(--medium-gray);
  font-size: 1rem;
  text-align: center;
}

.login-form {
  text-align: left;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--primary-blue);
}

.form-group input {
  width: 100%;
  padding: 14px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-family: 'Open Sans', sans-serif;
  font-size: 16px;
  transition: var(--transition);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1);
}

.form-error {
  color: var(--red);
  margin-top: 10px;
  font-weight: 600;
  display: none;
  font-size: 0.9rem;
}

.login-btns {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

.btn-modal {
  padding: 14px 30px;
  min-width: 140px;
}

/* ========== 修改以下样式 ========== */

/* Training Info Modal - 改为和登录框一样的样式 */
.training-info-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  z-index: 3001;
  display: none;
  justify-content: center;
  align-items: flex-start; /* 改这里：从center改为flex-start */
  padding: 20px;
  overflow-y: auto; /* 加这行：启用垂直滚动 */
}

.training-info-content {
  background-color: var(--white);
  padding: 30px;
  border-radius: var(--border-radius);
  max-width: 700px;
  width: 100%;
  margin: 40px auto; /* 改这里：添加上下边距 */
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFade 0.4s ease-out;
  /* 添加这两行 */
  max-height: calc(100vh - 80px);
  overflow-y: auto;
}

/* ========== 删除下面这些旧的响应式样式（如果有的话）========== */
/*
.training-info-content {
  max-height: 90vh;
}
*/

/* 保持现有的响应式样式，但要修改max-height值 */
@media (min-width: 768px) {
  .training-info-content {
    padding: 25px;
    margin: 20px auto; /* 调整边距 */
    max-height: 85vh; /* 改为使用vh单位 */
  }
}

@media (max-width: 576px) {
  .training-info-content {
    padding: 15px;
    margin: 10px auto; /* 调整边距 */
    max-height: 90vh; /* 改为使用vh单位 */
  }
  
  .training-info-header h2 {
    font-size: 1.3rem;
    margin-bottom: 8px;
  }
}

@media (max-width: 375px) {
  .training-info-content {
    padding: 10px;
    margin: 5px auto; /* 调整边距 */
    max-height: 95vh; /* 增加高度 */
  }
  
  .training-info-header h2 {
    font-size: 1.2rem;
  }
}
.training-info-header {
  text-align: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
}

.training-info-header h2 {
  font-size: 1.8rem;
  margin-bottom: 10px;
  color: var(--primary-blue);
}

.training-info-header p {
  color: var(--medium-gray);
  font-size: 1rem;
}

.training-info-body {
  margin-bottom: 25px;
}

.training-type-info {
  background-color: rgba(0, 64, 128, 0.1);
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid var(--primary-blue);
}

.training-type-info h3 {
  color: var(--primary-blue);
  margin-bottom: 10px;
  font-size: 1.3rem;
}

.training-type-info p {
  margin-bottom: 8px;
  line-height: 1.5;
}

.training-type-info .chinese {
  color: var(--medium-gray);
  font-style: italic;
  margin-top: 5px;
  padding-left: 15px;
  border-left: 3px solid #ddd;
}

.access-days-info {
  background-color: rgba(243, 156, 18, 0.1);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid var(--orange);
  text-align: center;
}

.access-days-info i {
  color: var(--orange);
  margin-right: 8px;
}

/* 移除题目分布部分的样式 */

/* Test Container */
.test-container {
  display: none;
}

.test-container.show {
  display: block;
}

/* Question Counter - 增强样式 */
.question-counter {
  background-color: var(--white);
  padding: 20px;
  border-radius: var(--border-radius);
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.counter-info {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.progress-container {
  flex-grow: 1;
  max-width: 400px;
  min-width: 200px;
}

.progress-bar {
  height: 10px;
  background-color: #e0e0e0;
  border-radius: 5px;
  overflow: hidden;
  margin-top: 5px;
}

.progress-fill {
  height: 100%;
  background-color: var(--primary-blue);
  width: 0%;
  transition: width 0.5s ease;
}

/* Question Card - 增强版 */
.question-card {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.question-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
}

.question-tag {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
}

.question-tag i {
  margin-right: 5px;
  font-size: 0.8rem;
}

.tag-category {
  background-color: rgba(0, 64, 128, 0.1);
  color: var(--primary-blue);
}

.tag-difficulty {
  background-color: rgba(243, 156, 18, 0.1);
  color: var(--orange);
}

.tag-type {
  background-color: rgba(155, 89, 182, 0.1);
  color: var(--purple);
}

.tag-theme {
  background-color: rgba(39, 174, 96, 0.1);
  color: var(--green);
}

.question-text {
  font-size: 1.4rem;
  margin-bottom: 25px;
  color: var(--dark-gray);
  font-weight: 600;
  line-height: 1.4;
}

/* Options with ABCD labels */
.options-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 25px;
}

.option {
  display: flex;
  align-items: flex-start;
  padding: 16px 18px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition);
  background-color: #f9f9f9;
}

.option:hover {
  background-color: #f0f7ff;
  border-color: var(--primary-light-blue);
}

.option.selected {
  background-color: #e6f2ff;
  border-color: var(--primary-blue);
}

.option.correct {
  background-color: rgba(39, 174, 96, 0.1);
  border-color: var(--green);
}

.option.incorrect {
  background-color: rgba(231, 76, 60, 0.1);
  border-color: var(--red);
}

.option-letter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background-color: var(--primary-blue);
  color: white;
  border-radius: 50%;
  font-weight: bold;
  margin-right: 12px;
  flex-shrink: 0;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.9rem;
}

.option.correct .option-letter {
  background-color: var(--green);
}

.option.incorrect .option-letter {
  background-color: var(--red);
}

.option input {
  display: none;
}

.option label {
  cursor: pointer;
  font-size: 1.1rem;
  flex-grow: 1;
  display: flex;
  align-items: flex-start;
  line-height: 1.4;
}

/* 答案反馈区域 */
.answer-feedback {
  display: none;
  margin-top: 30px;
  padding: 25px;
  border-radius: var(--border-radius);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.answer-feedback.correct {
  background-color: rgba(39, 174, 96, 0.1);
  border-left: 4px solid var(--green);
}

.answer-feedback.incorrect {
  background-color: rgba(231, 76, 60, 0.1);
  border-left: 4px solid var(--red);
}

.feedback-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
}

.feedback-icon {
  font-size: 2.5rem;
}

.feedback-icon.correct {
  color: var(--green);
}

.feedback-icon.incorrect {
  color: var(--red);
}

.feedback-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--dark-gray);
}

.feedback-explanation {
  font-size: 1.1rem;
  line-height: 1.6;
  color: var(--dark-gray);
  margin-bottom: 25px;
}

.next-question-btn {
  text-align: center;
  margin-top: 20px;
  display: none;
}

/* Navigation */
.navigation-btns {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  gap: 20px;
  flex-wrap: wrap;
}

.nav-btn {
  padding: 14px 30px;
  min-width: 150px;
  flex: 1;
  min-width: 120px;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Results */
.results-container {
  display: none;
}

.results-container.show {
  display: block;
  animation: fadeIn 0.5s ease;
}

.results-content {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 40px;
  margin-top: 40px;
  box-shadow: var(--shadow);
  text-align: center;
}

.results-header {
  margin-bottom: 40px;
}

.score-display {
  font-size: 4rem;
  font-weight: 800;
  color: var(--primary-blue);
  margin-bottom: 10px;
}

.score-text {
  font-size: 1.8rem;
  margin-bottom: 30px;
  line-height: 1.3;
}

.score-bar {
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  margin: 30px 0;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}

.score-fill {
  height: 100%;
  background-color: var(--green);
  width: 0%;
  transition: width 1.5s ease;
}

/* Question Map */
.question-map-container {
  background-color: var(--light-gray);
  padding: 25px;
  border-radius: var(--border-radius);
  margin: 40px 0;
}

.question-map-container h3 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: var(--primary-blue);
  text-align: center;
}

.question-map {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.map-item {
  width: 100%;
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
  border: 2px solid transparent;
}

.map-item:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.map-item.unanswered {
  background-color: #f0f0f0;
  color: var(--medium-gray);
}

.map-item.correct {
  background-color: var(--green);
  color: white;
}

.map-item.incorrect {
  background-color: var(--red);
  color: white;
}

.map-item.current {
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 2px var(--primary-blue);
}

.map-legend {
  display: flex;
  justify-content: center;
  gap: 25px;
  font-size: 0.9rem;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-color {
  width: 15px;
  height: 15px;
  border-radius: 3px;
}

.legend-color.unanswered {
  background-color: #f0f0f0;
}

.legend-color.correct {
  background-color: var(--green);
}

.legend-color.incorrect {
  background-color: var(--red);
}

/* Question Review */
.question-review-container {
  background-color: var(--white);
  border-radius: var(--border-radius);
  padding: 30px;
  margin: 30px 0;
  box-shadow: var(--shadow);
  display: none;
}

.question-review-container.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--light-gray);
  flex-wrap: wrap;
  gap: 15px;
}

.review-header h4 {
  font-size: 1.3rem;
  color: var(--primary-blue);
  margin: 0;
}

.review-question {
  font-size: 1.2rem;
  margin-bottom: 25px;
  color: var(--dark-gray);
  font-weight: 600;
  line-height: 1.5;
}

.review-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 25px;
}

.review-option {
  display: flex;
  align-items: flex-start;
  padding: 15px;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  position: relative;
}

.review-option.correct-answer {
  border-color: var(--green);
  background-color: rgba(39, 174, 96, 0.05);
}

.review-option.user-answer {
  border-color: var(--primary-blue);
  background-color: rgba(0, 64, 128, 0.05);
}

.review-option.user-answer.incorrect {
  border-color: var(--red);
  background-color: rgba(231, 76, 60, 0.05);
}

.review-option-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 25px;
  height: 25px;
  background-color: var(--primary-blue);
  color: white;
  border-radius: 50%;
  font-weight: bold;
  margin-right: 12px;
  flex-shrink: 0;
  font-size: 0.9rem;
}

.review-option.correct-answer .review-option-label {
  background-color: var(--green);
}

.review-option.user-answer.incorrect .review-option-label {
  background-color: var(--red);
}

.review-option-text {
  flex-grow: 1;
  font-size: 1rem;
}

.review-option-badge {
  position: absolute;
  top: -10px;
  right: 10px;
  background-color: var(--green);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.review-option.user-answer .review-option-badge {
  background-color: var(--primary-blue);
}

.review-option.user-answer.incorrect .review-option-badge {
  background-color: var(--red);
}

.review-explanation {
  background-color: rgba(255, 214, 51, 0.1);
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
  border-left: 4px solid var(--primary-yellow);
}

.review-explanation h5 {
  color: var(--primary-blue);
  margin-bottom: 10px;
  font-size: 1.1rem;
}

.review-explanation p {
  color: var(--dark-gray);
  line-height: 1.6;
}

.results-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 50px;
  flex-wrap: wrap;
}

/* Footer */
.test-footer {
  background-color: var(--primary-blue);
  color: var(--white);
  padding: 40px 0;
  margin-top: 80px;
  text-align: center;
  display: none;
}

.test-footer a {
  color: var(--primary-yellow);
  font-weight: 600;
}

/* Loading Spinner */
.loading-spinner {
  display: none;
  text-align: center;
  padding: 30px;
}

.spinner {
  border: 5px solid #f3f3f3;
  border-top: 5px solid var(--primary-blue);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 烟花和心碎动画效果 */
@keyframes fireworks {
  0% { transform: scale(0.8); opacity: 0.5; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes heartbreak {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  75% { transform: rotate(15deg); }
  100% { transform: rotate(0deg); }
}

.fireworks {
  animation: fireworks 1s ease-in-out 3;
}

.heartbreak {
  animation: heartbreak 0.5s ease-in-out 3;
}

/* Test Header */
.test-header {
  display: none;
  background-color: var(--white);
  padding: 20px 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.test-header .container {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.test-header h1 {
  font-size: 1.8rem;
  margin: 0;
}

.test-header p {
  color: var(--medium-gray);
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.header-actions .btn {
  padding: 10px 20px;
  font-size: 0.9rem;
}

/* 全局滚动条样式 */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Responsive - 移动端优先设计 */

/* 平板 - 768px以上 */
@media (min-width: 768px) {
  .training-info-content {
    padding: 25px;
    margin: 20px auto;
    max-height: 90vh;
  }
  
  .training-info-header h2 {
    font-size: 1.8rem;
  }
}

/* 小手机优化 - 576px以下 */
@media (max-width: 576px) {
  .training-info-content {
    padding: 15px;
    margin: 5px auto;
    max-height: 98vh;
  }
  
  .training-info-header h2 {
    font-size: 1.3rem;
    margin-bottom: 8px;
  }
  
  .training-type-info {
    padding: 15px;
  }
  
  /* 其他页面的移动端优化 */
  .question-map {
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }
  
  .map-item {
    font-size: 0.9rem;
  }
  
  .question-card {
    padding: 20px;
  }
  
  .question-text {
    font-size: 1.2rem;
  }
  
  .option {
    padding: 12px 15px;
  }
  
  .option-letter {
    width: 25px;
    height: 25px;
    font-size: 0.8rem;
  }
  
  .navigation-btns {
    flex-direction: column;
  }
  
  .nav-btn {
    width: 100%;
  }
  
  .results-actions {
    flex-direction: column;
  }
  
  .results-actions .btn {
    width: 100%;
    margin-bottom: 10px;
  }
  
  .score-display {
    font-size: 2.5rem;
  }
  
  .score-text {
    font-size: 1.3rem;
  }
}

/* 超小手机 - 375px以下 */
@media (max-width: 375px) {
  .question-map {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .training-info-content {
    padding: 10px;
  }
  
  .training-info-header h2 {
    font-size: 1.2rem;
  }
}
</style>
</head>
<body>

<!-- Custom Alert Modal -->
<div id="alertModal" class="alert-overlay">
  <div class="alert-content">
    <div class="alert-icon info" id="alertIcon">
      <i class="fas fa-info-circle"></i>
    </div>
    <h2 id="alertTitle">Information</h2>
    <p id="alertMessage">Message d'information</p>
    <div class="alert-btns">
      <button class="btn btn-primary" onclick="closeAlert()">OK</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="login-overlay">
  <div class="login-content">
    <h2>Accès Test des Valeurs Républicaines</h2>
    <p>Veuillez entrer vos informations d'étudiant</p>
    
    <form id="loginForm" class="login-form">
      <div class="form-group">
        <label for="studentName">Nom de l'étudiant *</label>
        <input type="text" id="studentName" placeholder="Votre nom complet" required>
      </div>
      
      <div class="form-group">
        <label for="studentPassword">Mot de passe *</label>
        <input type="password" id="studentPassword" placeholder="Mot de passe fourni" required>
        <div class="form-error" id="loginError">Nom ou mot de passe incorrect</div>
      </div>
      
      <div style="background-color: rgba(243,156,18,0.1); border-left: 4px solid var(--orange); padding: 12px; border-radius: 0 8px 8px 0; margin: 20px 0; font-size: 0.9rem;">
        <p><i class="fas fa-info-circle"></i> Test spécialisé : 20 questions - Pas de limite de temps</p>
        <p><i class="fas fa-check-circle"></i> Thèmes : Valeurs de la République et Laïcité</p>
      </div>
    </form>
    
    <div class="loading-spinner" id="loginSpinner" style="display: none;">
      <div class="spinner"></div>
      <p>Connexion en cours...</p>
    </div>
    
    <div class="login-btns" id="loginButtons">
      <button class="btn btn-primary btn-modal" onclick="validateLogin()">
        <i class="fas fa-sign-in-alt"></i> Se connecter
      </button>
      <button class="btn btn-modal" onclick="goBackToHome()">
        <i class="fas fa-home"></i> Accueil
      </button>
    </div>
  </div>
</div>

<!-- 找到这个部分 -->
<div id="trainingInfoModal" class="training-info-modal">
  <div class="training-info-content">
    <!-- 在这两行中间添加： -->
    <div style="max-height: 100%; overflow-y: auto; padding-right: 5px;">
    
    <div class="training-info-header">
      <h2>Informations sur votre formation</h2>
      <p>Informations sur le test et votre compte</p>
    </div>
    
    <div class="training-info-body">
      <div class="training-type-info" id="trainingTypeInfo">
        <!-- 内容不变 -->
      </div>
      
      <div class="access-days-info" id="accessDaysInfo" style="display: none;">
        <!-- 内容不变 -->
      </div>
      
      <!-- 添加这个额外信息块让内容更充实 -->
      <div style="margin-top: 30px; padding: 15px; background-color: rgba(0, 64, 128, 0.05); border-radius: 8px; border-left: 4px solid var(--primary-blue);">
        <h3 style="color: var(--primary-blue); margin-bottom: 10px; font-size: 1.1rem;">
          <i class="fas fa-lightbulb"></i> Conseils pour le test
        </h3>
        <ul style="color: var(--medium-gray); padding-left: 20px; line-height: 1.6;">
          <li>Prenez votre temps, il n'y a pas de limite de temps</li>
          <li>Lisez attentivement chaque question</li>
          <li>Consultez les explications après chaque réponse</li>
          <li>Le test peut être recommencé si nécessaire</li>
          <li>Seuil de réussite : 16/20 (80%)</li>
        </ul>
      </div>
    </div>
    
    <div class="alert-btns">
      <button class="btn btn-primary" onclick="closeTrainingInfo()">
        <i class="fas fa-play-circle"></i> Commencer le test
      </button>
    </div>
    
    <!-- 在这行之前添加： -->
    </div>
  </div>
</div>

<!-- Test Header -->
<header class="test-header" style="display: none;">
  <div class="container">
    <h1 id="testTitle">Valeurs de la République et Laïcité</h1>
    <p id="testSubtitle">20 questions - Pas de limite de temps</p>
    <div class="header-actions">
      <button class="btn" onclick="showInstructions()">
        <i class="fas fa-info-circle"></i> Instructions
      </button>
      <button class="btn" onclick="restartTest()">
        <i class="fas fa-redo"></i> Recommencer
      </button>
      <button class="btn btn-primary" onclick="goBackToHome()">
        <i class="fas fa-home"></i> Accueil
      </button>
    </div>
  </div>
</header>

<!-- Test Container -->
<main class="container">
  <div id="testContainer" class="test-container">
    <!-- Question Counter -->
    <div class="question-counter">
      <div class="counter-info">
        <div>
          <h3>Question <span id="currentQuestion">1</span> sur <span id="totalQuestions">20</span></h3>
          <p id="testTypeInfo">Test des Valeurs Républicaines</p>
        </div>
        <div class="progress-container">
          <div>Progression: <span id="progressPercent">0%</span></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Question -->
    <div class="question-card">
      <!-- 题目元数据标签区域 -->
      <div class="question-meta" id="questionMeta">
        <!-- 标签将由JavaScript动态添加 -->
      </div>
      
      <div class="question-text" id="questionText">Chargement de la question...</div>
      
      <div class="options-container" id="optionsContainer">
        <!-- Options will be inserted here by JavaScript -->
      </div>
      
      <!-- 答案反馈区域 -->
      <div class="answer-feedback" id="answerFeedback">
        <!-- 反馈内容将由JavaScript动态添加 -->
      </div>
      
      <!-- 下一题按钮 -->
      <div class="next-question-btn" id="nextQuestionBtn">
        <button class="btn btn-primary" onclick="nextQuestion()">
          <i class="fas fa-arrow-right"></i> Question suivante
        </button>
      </div>
      
      <div class="navigation-btns">
        <button class="btn nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>
          <i class="fas fa-arrow-left"></i> Précédente
        </button>
        <button class="btn btn-primary nav-btn" id="submitBtn" onclick="submitCurrentQuestion()" style="display: none;">
          Valider la réponse
        </button>
      </div>
    </div>
    
    <!-- 提交测试按钮（在最后一题显示） -->
    <div style="text-align: center; margin-top: 40px;">
      <button class="btn btn-primary" id="finishTestBtn" onclick="submitTest()" style="padding: 18px 50px; font-size: 1.2rem; display: none;">
        <i class="fas fa-paper-plane"></i> Terminer le test
      </button>
    </div>
  </div>
  
  <!-- Results Container -->
  <div id="resultsContainer" class="results-container">
    <div class="results-content">
      <div class="results-header">
        <!-- 显示总分 -->
        <div class="score-display" id="scoreDisplay">0/20</div>
        <div class="score-text" id="scoreText">Chargement du résultat...</div>
        
        <!-- 显示进度条 -->
        <div class="score-bar">
          <div class="score-fill" id="scoreFill"></div>
        </div>
      </div>
      
      <!-- Question Map -->
      <div class="question-map-container" id="questionMapContainer">
        <h3>Carte des Réponses</h3>
        <div class="question-map" id="questionMap">
          <!-- Question map will be inserted here by JavaScript -->
        </div>
        <div class="map-legend">
          <div class="legend-item">
            <div class="legend-color unanswered"></div>
            <span>Non répondue</span>
          </div>
          <div class="legend-item">
            <div class="legend-color correct"></div>
            <span>Correcte</span>
          </div>
          <div class="legend-item">
            <div class="legend-color incorrect"></div>
            <span>Incorrecte</span>
          </div>
        </div>
      </div>
      
      <!-- Question Review -->
      <div class="question-review-container" id="questionReview">
        <!-- Question review will be inserted here when user clicks on map -->
      </div>
      
      <div class="results-actions">
        <button class="btn" onclick="restartTest()">
          <i class="fas fa-redo"></i> Nouveau test
        </button>
        <button class="btn btn-primary" onclick="goBackToHome()">
          <i class="fas fa-home"></i> Accueil
        </button>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="test-footer">
  <div class="container">
    <p>© 2026 Association Mille Voiles</p>
    <p id="footerTestInfo">Test des Valeurs Républicaines - Simulation spécialisée</p>
    <p><a href="index.html">Retour au site principal</a></p>
  </div>
</footer>

<script src="compte.js"></script>
<script src="question_multia.js"></script>
<script src="question_resident.js"></script>

<script>
// ==================== 全局配置 ====================
// 禁止右键
document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
});

// 禁止常见快捷键
document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && ['c', 'u', 's', 'x', 'v', 'a'].includes(e.key.toLowerCase())) {
        e.preventDefault();
    }
    if (e.key === 'F12') {
        e.preventDefault();
    }
});

// ==================== 主题分布配置 ====================
// 更新为主题分布：Laïcité 3道，Devise et symboles 7道，Mises en situation 10道
const themeDistribution = {
    "Laïcité": 3,
    "Devise et symboles de la République": 7,
    "Mises en situation": 10
};

// ==================== 全局变量 ====================
let studentInfo = { name: "", testDate: "", type: "", daysLeft: 0 };
let selectedQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let answeredQuestions = new Set(); // 记录已回答的题目
let currentAnswerSubmitted = false; // 当前题目是否已提交

let currentScore = 0;
let currentPercentage = 0;
let currentScoreText = "";

let allQuestions = [];

// ==================== 自定义提示窗口 ====================
function showAlert(title, message, type = 'info') {
    const alertModal = document.getElementById('alertModal');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = document.getElementById('alertIcon');
    
    // 设置标题和消息
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    
    // 设置图标类型
    alertIcon.className = 'alert-icon';
    switch(type) {
        case 'success':
            alertIcon.classList.add('success');
            alertIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            break;
        case 'warning':
            alertIcon.classList.add('warning');
            alertIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            break;
        case 'error':
            alertIcon.classList.add('error');
            alertIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            break;
        case 'info':
        default:
            alertIcon.classList.add('info');
            alertIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            break;
    }
    
    // 显示窗口
    alertModal.style.display = 'flex';
}

function closeAlert() {
    document.getElementById('alertModal').style.display = 'none';
}

// ==================== 培训信息窗口 ====================
// ==================== 培训信息窗口 ====================
function showTrainingInfo() {
    const trainingTypeInfo = document.getElementById('trainingTypeInfo');
    const accessDaysInfo = document.getElementById('accessDaysInfo');
    
    // 根据学生类型显示不同的培训信息
    let trainingHTML = '';
    let difficultyNote = '';
    
    switch(studentInfo.type) {
        case 'm': // 四年居留
            trainingHTML = `
                <h3><i class="fas fa-passport"></i> Formation : Valeurs de la République et Laïcité</h3>
                <p><strong>Public visé :</strong> Demandeurs de titre de séjour pluriannuel (2-4 ans)</p>
                <p><strong>Target audience :</strong> Multi-year residence permit applicants (2-4 years)</p>
                <div class="chinese">
                    <strong>适用对象：</strong> 2-4年居留许可申请者
                </div>
            `;
            difficultyNote = '<p><strong>Note :</strong> Questions adaptées à la compréhension des valeurs républicaines et du principe de laïcité pour les résidents.</p>';
            break;
            
        case 'n': // 入籍
            trainingHTML = `
                <h3><i class="fas fa-flag"></i> Formation : Valeurs de la République et Laïcité</h3>
                <p><strong>Public visé :</strong> Demandeurs de nationalité française</p>
                <p><strong>Target audience :</strong> French nationality applicants</p>
                <div class="chinese">
                    <strong>适用对象：</strong> 法国入籍申请者
                </div>
            `;
            difficultyNote = '<p><strong>Note :</strong> Questions approfondies sur les fondements de la République, la devise et la laïcité.</p>';
            break;
            
        case 'r': // 十年居留
            trainingHTML = `
                <h3><i class="fas fa-id-card-alt"></i> Formation : Valeurs de la République et Laïcité</h3>
                <p><strong>Public visé :</strong> Demandeurs de carte de résident de 10 ans</p>
                <p><strong>Target audience :</strong> 10-year resident card applicants</p>
                <div class="chinese">
                    <strong>适用对象：</strong> 10年居留卡申请者
                </div>
            `;
            difficultyNote = '<p><strong>Note :</strong> Questions sur l\'intégration aux valeurs de la République et la compréhension de la laïcité.</p>';
            break;
            
        case 't': // 所有类型
            trainingHTML = `
                <h3><i class="fas fa-graduation-cap"></i> Formation : Valeurs de la République et Laïcité</h3>
                <p><strong>Public visé :</strong> Tous les demandeurs (accès complet)</p>
                <p><strong>Target audience :</strong> All applicants (full access)</p>
                <div class="chinese">
                    <strong>适用对象：</strong> 所有申请者（完全访问权限）
                </div>
            `;
            difficultyNote = '<p><strong>Note :</strong> Vous avez accès à toutes les questions sur les valeurs de la République et la laïcité.</p>';
            break;
    }
    
    trainingHTML += difficultyNote;
    
    // 添加测试具体信息
    trainingHTML += `
        <div style="margin-top: 15px; padding: 12px; background-color: rgba(0, 64, 128, 0.08); border-radius: 6px;">
            <p style="margin-bottom: 8px;"><strong><i class="fas fa-question-circle"></i> Test spécialisé :</strong></p>
            <p>• 20 questions sur les valeurs de la République et la laïcité</p>
            <p>• Pas de limite de temps</p>
            <p>• Seuil de réussite : 16/20 (80%)</p>
            <div class="chinese">
                <p style="margin-top: 5px;">• 20道题关于共和国价值观和政教分离</p>
                <p>• 无时间限制</p>
                <p>• 通过标准：16/20 (80%)</p>
            </div>
        </div>
    `;
    
    trainingTypeInfo.innerHTML = trainingHTML;
    
    // 显示剩余天数信息
    if (studentInfo.daysLeft > 0) {
        accessDaysInfo.style.display = 'block';
        if (studentInfo.daysLeft === 1) {
            accessDaysInfo.innerHTML = `<p><i class="fas fa-calendar-day"></i> Votre accès est valide pour encore <strong>1 jour</strong>.</p>`;
        } else {
            accessDaysInfo.innerHTML = `<p><i class="fas fa-calendar-alt"></i> Votre accès est valide pour encore <strong>${studentInfo.daysLeft} jours</strong>.</p>`;
        }
    } else if (studentInfo.daysLeft === -1) {
        accessDaysInfo.style.display = 'block';
        accessDaysInfo.innerHTML = `<p><i class="fas fa-infinity"></i> Votre accès est valide <strong>sans limitation de durée</strong>.</p>`;
    }
    
    // 显示培训信息窗口
    document.getElementById('trainingInfoModal').style.display = 'flex';
}
function closeTrainingInfo() {
    document.getElementById('trainingInfoModal').style.display = 'none';
    startTest();
}

// ==================== 登录验证 ====================
function validateLogin() {
    console.log("登录按钮被点击");
    
    const name = document.getElementById('studentName').value.trim();
    const password = document.getElementById('studentPassword').value.trim();
    const loginError = document.getElementById('loginError');
    const loadingSpinner = document.getElementById('loginSpinner');
    const loginButtons = document.getElementById('loginButtons');
    
    if (!name || !password) {
        showAlert("Champs requis", "Veuillez remplir tous les champs.", 'warning');
        return;
    }
    
    // 显示加载状态
    loginError.style.display = 'none';
    loginButtons.style.display = 'none';
    loadingSpinner.style.display = 'block';
    
    console.log("尝试Supabase登录:", name);
    
    // 使用Supabase验证（和之前测试系统一样）
    window.supabaseAuth.validateStudent(name, password)
        .then(student => {
            if (student) {
                console.log("登录成功:", student);
                
                // 检查访问权限
                const accessCheck = window.supabaseAuth.checkAccess(student);
                
                if (!accessCheck.valid) {
                    showAlert("Accès expiré", 
                        accessCheck.message || "Votre période d'accès a expiré.", 
                        'error');
                    resetLoginForm();
                    return;
                }
                
                // 存储学生信息
                studentInfo = {
                    name: student.name,
                    testDate: new Date().toLocaleString('fr-FR'),
                    type: student.type || "t",
                    daysLeft: accessCheck.daysLeft
                };
                
                console.log("学生信息保存:", studentInfo);
                
                // 登录成功，隐藏登录窗口
                document.getElementById('loginModal').style.display = 'none';
                
                // 显示培训信息窗口
                showTrainingInfo();
                
            } else {
                console.log("登录失败: 用户名或密码错误");
                showAlert("Échec de connexion", "Nom d'étudiant ou mot de passe incorrect.", 'error');
                resetLoginForm();
            }
        })
        .catch(error => {
            console.error("登录错误:", error);
            showAlert("Erreur de connexion", "Une erreur est survenue. Veuillez réessayer.", 'error');
            resetLoginForm();
        });
}

// 重置登录表单
function resetLoginForm() {
    const loginSpinner = document.getElementById('loginSpinner');
    const loginButtons = document.getElementById('loginButtons');
    
    loginSpinner.style.display = 'none';
    loginButtons.style.display = 'flex';
}

// ==================== 开始测试 ====================
function startTest() {
    // 显示加载动画
    document.getElementById('trainingInfoModal').style.display = 'none';
    
    // 创建加载提示
    showAlert("Préparation du test", "Chargement des questions en cours...", 'info');
    
    setTimeout(() => {
        try {
            // 根据学生类型选择题库
            if (studentInfo.type === 'm') {
                // 四年居留：只用 question_multia
                allQuestions = [...question_multi];
                console.log("四年居留题库：使用 question_multia，总数:", allQuestions.length);
            } else {
                // 十年居留和入籍：用 question_multia + question_resident
                allQuestions = [...question_multi];
                if (typeof question_resident !== 'undefined' && question_resident.length > 0) {
                    allQuestions = allQuestions.concat(question_resident);
                }
                console.log("十年居留/入籍题库：使用 question_multia + question_resident，总数:", allQuestions.length);
            }
            
            if (allQuestions.length === 0) {
                throw new Error("题库为空，请检查题库文件");
            }
            
            // 隐藏提示窗口
            closeAlert();
            
            // 显示测试界面
            document.querySelector('.test-header').style.display = 'block';
            document.getElementById('testContainer').classList.add('show');
            document.querySelector('.test-footer').style.display = 'block';
            
            // 更新测试标题
            document.getElementById('testTitle').textContent = "Valeurs Républicaines et Laïcité";
            document.getElementById('testSubtitle').textContent = "Test spécialisé sur les principes fondamentaux";
            document.getElementById('testTypeInfo').textContent = "Test des Valeurs de la République";
            document.getElementById('footerTestInfo').textContent = 
                `Valeurs Républicaines - 20 questions - Pas de limite de temps`;
            
            initializeTest();
            
        } catch (error) {
            console.error("初始化测试失败:", error);
            showAlert("Erreur d'initialisation", error.message || "Erreur lors de l'initialisation du test.", 'error');
        }
    }, 1500);
}

// ==================== 根据主题分布选择题目 ====================
function selectQuestionsByTheme() {
    console.log("开始按主题分布选择题目...");
    
    // 1. 按主题分组题目
    const questionsByTheme = {};
    
    allQuestions.forEach((question) => {
        const theme = question.theme || question.category || "Autre";
        if (!questionsByTheme[theme]) {
            questionsByTheme[theme] = [];
        }
        questionsByTheme[theme].push(question);
    });
    
    console.log("题库主题分布:", Object.keys(questionsByTheme));
    
    // 2. 专门处理Mises en situation - 从si001到si0047中随机选择
    let situationQuestions = [];
    if (questionsByTheme["Mises en situation"]) {
        situationQuestions = questionsByTheme["Mises en situation"];
    } else {
        // 如果没有"Mises en situation"分类，尝试从所有题目中筛选id以"si"开头的
        situationQuestions = allQuestions.filter(q => {
            const id = q.id || "";
            return id.toLowerCase().startsWith("si") && parseInt(id.substring(2)) >= 1 && parseInt(id.substring(2)) <= 47;
        });
    }
    
    console.log("Mises en situation题目数量:", situationQuestions.length);
    
    // 3. 根据配置选择题目
    selectedQuestions = [];
    let totalSelected = 0;
    
    // 选择Laïcité题目
    const laiciteQuestions = questionsByTheme["Laïcité"] || [];
    if (laiciteQuestions.length > 0) {
        const shuffled = shuffleArray([...laiciteQuestions]);
        const selected = shuffled.slice(0, Math.min(3, laiciteQuestions.length));
        selectedQuestions.push(...selected);
        totalSelected += selected.length;
    } else {
        console.warn("警告：没有找到Laïcité题目");
    }
    
    // 选择Devise et symboles题目
    const deviseQuestions = questionsByTheme["Devise et symboles de la République"] || [];
    if (deviseQuestions.length > 0) {
        const shuffled = shuffleArray([...deviseQuestions]);
        const selected = shuffled.slice(0, Math.min(7, deviseQuestions.length));
        selectedQuestions.push(...selected);
        totalSelected += selected.length;
    } else {
        console.warn("警告：没有找到Devise et symboles de la République题目");
    }
    
    // 选择Mises en situation题目
    if (situationQuestions.length > 0) {
        const shuffled = shuffleArray([...situationQuestions]);
        const selected = shuffled.slice(0, Math.min(10, situationQuestions.length));
        selectedQuestions.push(...selected);
        totalSelected += selected.length;
    } else {
        console.warn("警告：没有找到Mises en situation题目");
    }
    
    console.log(`已选择 ${totalSelected} 题`);
    
    // 4. 如果题目不足20，从其他题目中补充
    if (totalSelected < 20) {
        const needed = 20 - totalSelected;
        
        const selectedSet = new Set(selectedQuestions);
        const availableQuestions = allQuestions.filter(q => !selectedSet.has(q));
        
        if (availableQuestions.length > 0) {
            const shuffled = shuffleArray([...availableQuestions]);
            const toAdd = shuffled.slice(0, Math.min(needed, availableQuestions.length));
            selectedQuestions.push(...toAdd);
        }
    }
    
    // 如果题目太多，截取前20题
    if (selectedQuestions.length > 20) {
        selectedQuestions = selectedQuestions.slice(0, 20);
    }
    
    // 最终随机打乱所有题目顺序
    selectedQuestions = shuffleArray(selectedQuestions);
    
    console.log(`最终选择 ${selectedQuestions.length} 题`);
    
    // 为题目添加标签 - 修复重复标签问题
    selectedQuestions = selectedQuestions.map((question) => {
        const theme = question.theme || question.category || "Autre";
        let tags = [];
        
        // 根据主题添加主要标签（只加一个）
        if (theme.includes("Laïcité")) {
            tags.push("Laïcité");
        } else if (theme.includes("Devise") || theme.includes("symboles")) {
            tags.push("Symboles");
        } else if (theme.includes("Mises en situation") || (question.id && question.id.toLowerCase().startsWith("si"))) {
            tags.push("Situation");
        }
        
        // 只添加难度标签（如果存在）
        if (question.difficulté) {
            tags.push(question.difficulté);
        }
        
        // 只添加类型标签（如果存在）
        if (question.typeQuestion) {
            tags.push(question.typeQuestion);
        }
        
        return {
            ...question,
            customTags: tags,
            theme: theme // 确保theme字段存在
        };
    });
}

// Fisher-Yates 洗牌算法
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// ==================== 显示题目 - 修改为一道题一道题的交互模式 ====================
function showQuestion(index) {
    if (!selectedQuestions[index]) {
        console.error("题目不存在:", index);
        return;
    }
    
    const question = selectedQuestions[index];
    
    // 重置当前题目状态
    currentAnswerSubmitted = answeredQuestions.has(index);
    
    // 显示题目元数据标签 - 只显示一份
    const questionMeta = document.getElementById('questionMeta');
    questionMeta.innerHTML = '';
    
    // 添加主题标签（只显示一个主要标签）
    const theme = question.theme || question.category || "Autre";
    
    // 根据主题判断显示哪个标签
    let mainTag = '';
    if (theme.includes("Laïcité")) {
        mainTag = 'Laïcité';
    } else if (theme.includes("Devise") || theme.includes("symboles")) {
        mainTag = 'Symboles';
    } else if (theme.includes("Mises en situation") || (question.id && question.id.toLowerCase().startsWith("si"))) {
        mainTag = 'Situation';
    } else {
        mainTag = theme;
    }
    
    // 添加主题标签
    const themeTag = document.createElement('span');
    themeTag.className = 'question-tag tag-theme';
    themeTag.innerHTML = `<i class="fas fa-tag"></i> ${mainTag}`;
    questionMeta.appendChild(themeTag);
    
    // 添加难度标签（如果存在）
    if (question.difficulté) {
        const difficultyTag = document.createElement('span');
        difficultyTag.className = 'question-tag tag-difficulty';
        difficultyTag.innerHTML = `<i class="fas fa-chart-line"></i> ${question.difficulté}`;
        questionMeta.appendChild(difficultyTag);
    }
    
    // 添加类型标签（如果存在）
    if (question.typeQuestion) {
        const typeTag = document.createElement('span');
        typeTag.className = 'question-tag tag-type';
        typeTag.innerHTML = `<i class="fas fa-question-circle"></i> ${question.typeQuestion}`;
        questionMeta.appendChild(typeTag);
    }
    
    // 显示题目文本
    document.getElementById('questionText').textContent = `${index + 1}. ${question.question}`;
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    if (!question.options || question.options.length === 0) {
        console.error("题目选项为空:", question);
        return;
    }
    
    // 为选项分配ABCD标签
    const optionLetters = ['A', 'B', 'C', 'D'];
    
    question.options.forEach((option, optionIndex) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        
        // 如果已经回答了这道题，显示答案状态
        if (currentAnswerSubmitted) {
            if (optionIndex === question.answer) {
                optionDiv.classList.add('correct');
            }
            if (optionIndex === userAnswers[index] && optionIndex !== question.answer) {
                optionDiv.classList.add('incorrect');
            }
        } else if (userAnswers[index] === optionIndex) {
            optionDiv.classList.add('selected');
        }
        
        // 创建选项字母标签
        const letterSpan = document.createElement('span');
        letterSpan.className = 'option-letter';
        letterSpan.textContent = optionLetters[optionIndex];
        
        // 隐藏的radio input
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'question';
        input.id = `option${index}_${optionIndex}`;
        input.value = optionIndex;
        if (userAnswers[index] === optionIndex) {
            input.checked = true;
        }
        
        const label = document.createElement('label');
        label.htmlFor = `option${index}_${optionIndex}`;
        
        // 添加选项内容
        label.appendChild(letterSpan);
        label.appendChild(document.createTextNode(option));
        
        optionDiv.appendChild(input);
        optionDiv.appendChild(label);
        
        // 如果还没有提交答案，可以点击选择
        if (!currentAnswerSubmitted) {
            optionDiv.addEventListener('click', () => {
                userAnswers[index] = optionIndex;
                showQuestion(index);
                document.getElementById('submitBtn').style.display = 'block';
            });
        }
        
        optionsContainer.appendChild(optionDiv);
    });
    
    // 显示或隐藏提交按钮
    document.getElementById('submitBtn').style.display = 
        (!currentAnswerSubmitted && userAnswers[index] !== null) ? 'block' : 'none';
    
    // 显示或隐藏下一题按钮
    document.getElementById('nextQuestionBtn').style.display = 
        (currentAnswerSubmitted) ? 'block' : 'none';
    
    // 显示或隐藏完成测试按钮（最后一题）
    document.getElementById('finishTestBtn').style.display = 
        (index === selectedQuestions.length - 1 && answeredQuestions.size === selectedQuestions.length) ? 'block' : 'none';
    
    document.getElementById('prevBtn').disabled = index === 0;
    
    // 更新导航按钮状态
    updateNavigationButtons();
    
    // 显示答案反馈（如果已经提交）
    if (currentAnswerSubmitted) {
        showAnswerFeedback(index);
    } else {
        document.getElementById('answerFeedback').style.display = 'none';
    }
}

// ==================== 显示答案反馈 ====================
function showAnswerFeedback(index) {
    const question = selectedQuestions[index];
    const userAnswer = userAnswers[index];
    const isCorrect = userAnswer === question.answer;
    const feedbackDiv = document.getElementById('answerFeedback');
    
    feedbackDiv.className = `answer-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
    
    const feedbackHTML = `
        <div class="feedback-header">
            <div class="feedback-icon ${isCorrect ? 'correct' : 'incorrect'}">
                ${isCorrect ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'}
            </div>
            <div class="feedback-title">
                ${isCorrect ? 'Correct!' : 'Incorrect!'}
            </div>
        </div>
        ${question.explanation ? `
            <div class="feedback-explanation">
                <strong>Explication :</strong> ${question.explanation}
            </div>
        ` : ''}
    `;
    
    feedbackDiv.innerHTML = feedbackHTML;
    feedbackDiv.style.display = 'block';
    
    // 滚动到反馈区域
    setTimeout(() => {
        feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 300);
}

// ==================== 提交当前题目答案 ====================
function submitCurrentQuestion() {
    if (userAnswers[currentQuestionIndex] === null) {
        showAlert("Sélection requise", "Veuillez sélectionner une réponse avant de valider.", 'warning');
        return;
    }
    
    // 标记此题已提交
    answeredQuestions.add(currentQuestionIndex);
    currentAnswerSubmitted = true;
    
    // 显示答案反馈
    showAnswerFeedback(currentQuestionIndex);
    
    // 更新界面
    showQuestion(currentQuestionIndex);
    updateQuestionCounter();
    
    // 如果是最后一题，显示完成测试按钮
    if (currentQuestionIndex === selectedQuestions.length - 1) {
        document.getElementById('finishTestBtn').style.display = 'block';
    }
}

// ==================== 创建题目地图 ====================
function createQuestionMap() {
    const questionMap = document.getElementById('questionMap');
    questionMap.innerHTML = '';
    
    for (let i = 0; i < selectedQuestions.length; i++) {
        const mapItem = document.createElement('div');
        mapItem.className = 'map-item';
        mapItem.textContent = i + 1;
        
        // 设置状态
        if (!answeredQuestions.has(i)) {
            mapItem.classList.add('unanswered');
        } else {
            const isCorrect = userAnswers[i] === selectedQuestions[i].answer;
            if (isCorrect) {
                mapItem.classList.add('correct');
            } else {
                mapItem.classList.add('incorrect');
            }
        }
        
        // 添加点击事件
        mapItem.addEventListener('click', () => {
            showQuestionReview(i);
        });
        
        questionMap.appendChild(mapItem);
    }
}

// ==================== 显示题目回顾 ====================
function showQuestionReview(index) {
    const questionReview = document.getElementById('questionReview');
    const question = selectedQuestions[index];
    const userAnswerIndex = userAnswers[index];
    const isCorrect = userAnswerIndex === question.answer;
    const optionLetters = ['A', 'B', 'C', 'D'];
    
    let reviewHTML = `
        <div class="review-header">
            <h4>Question ${index + 1} - ${question.theme || question.category || "Autre"}</h4>
            <span style="color: ${isCorrect ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">
                ${isCorrect ? '✓ Correcte' : '✗ Incorrecte'}
            </span>
        </div>
        <div class="review-question">${question.question}</div>
        <div class="review-options">
    `;
    
    // 显示所有选项
    question.options.forEach((option, optionIndex) => {
        let optionClass = 'review-option';
        let badgeText = '';
        
        if (optionIndex === question.answer) {
            optionClass += ' correct-answer';
            badgeText = 'Réponse correcte';
        }
        
        if (optionIndex === userAnswerIndex) {
            optionClass += ' user-answer';
            if (optionIndex !== question.answer) {
                optionClass += ' incorrect';
                badgeText = 'Votre réponse (incorrecte)';
            } else {
                badgeText = 'Votre réponse (correcte)';
            }
        }
        
        reviewHTML += `
            <div class="${optionClass}">
                <span class="review-option-label">${optionLetters[optionIndex]}</span>
                <div class="review-option-text">${option}</div>
                ${badgeText ? `<span class="review-option-badge">${badgeText}</span>` : ''}
            </div>
        `;
    });
    
    reviewHTML += `
        </div>
    `;
    
    // 添加解释
    if (question.explanation) {
        reviewHTML += `
            <div class="review-explanation">
                <h5>Explication</h5>
                <p>${question.explanation}</p>
            </div>
        `;
    }
    
    questionReview.innerHTML = reviewHTML;
    questionReview.classList.add('active');
    
    // 滚动到回顾区域
    questionReview.scrollIntoView({ behavior: 'smooth' });
}

// ==================== 提交和评分 ====================
function submitTest() {
    // 检查是否所有题目都已回答
    if (answeredQuestions.size < selectedQuestions.length) {
        const unanswered = selectedQuestions.length - answeredQuestions.size;
        showAlert("Questions non répondues", 
            `${unanswered} question(s) non répondues. Souhaitez-vous soumettre quand même?`, 
            'warning');
        
        // 创建一个确认按钮
        setTimeout(() => {
            const alertBtns = document.querySelector('.alert-btns');
            alertBtns.innerHTML = `
                <button class="btn" onclick="closeAlert();">Annuler</button>
                <button class="btn btn-primary" onclick="closeAlert(); proceedWithSubmission();">Soumettre</button>
            `;
        }, 100);
        return;
    }
    
    proceedWithSubmission();
}

function proceedWithSubmission() {
    calculateScore();
    displayResults();
}

function calculateScore() {
    let correct = 0;
    
    selectedQuestions.forEach((question, index) => {
        if (userAnswers[index] === question.answer) {
            correct++;
        }
    });
    
    currentScore = correct;
    currentPercentage = Math.round((correct / selectedQuestions.length) * 100);
    
    // 显示通过/不通过，同时显示具体分数
    const passed = correct >= 16; // 80% of 20 = 16
    
    // 添加烟花或心碎效果
    if (passed) {
        currentScoreText = `🎉 Félicitations! Vous avez réussi le test! 🎉`;
    } else {
        currentScoreText = `💔 Désolé, vous n'avez pas réussi le test. 💔`;
    }
    
    // 添加分数详情
    currentScoreText += `\nScore: ${correct}/20 (${currentPercentage}%)`;
}

function displayResults() {
    document.getElementById('testContainer').style.display = 'none';
    
    // 显示分数
    document.getElementById('scoreDisplay').style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${currentScore}/20`;
    
    document.getElementById('scoreText').textContent = currentScoreText;
    document.getElementById('scoreText').style.fontSize = '1.5rem';
    document.getElementById('scoreText').style.fontWeight = 'bold';
    document.getElementById('scoreText').style.marginTop = '10px';
    document.getElementById('scoreText').style.marginBottom = '20px';
    document.getElementById('scoreText').style.whiteSpace = 'pre-line';
    
    // 应用动画效果
    if (currentScoreText.includes("🎉")) {
        document.getElementById('scoreText').classList.add('fireworks');
    } else if (currentScoreText.includes("💔")) {
        document.getElementById('scoreText').classList.add('heartbreak');
    }
    
    // 显示进度条
    document.querySelector('.score-bar').style.display = 'block';
    setTimeout(() => {
        document.getElementById('scoreFill').style.width = currentPercentage + '%';
    }, 300);
    
    // 创建题目地图
    createQuestionMap();
    
    document.getElementById('resultsContainer').classList.add('show');
    
    // 滚动到结果区域
    setTimeout(() => {
        document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
    }, 500);
}

// ==================== 其他功能 ====================
function restartTest() {
    showAlert("Recommencer le test", 
        "Voulez-vous vraiment recommencer le test? Vos réponses actuelles seront perdues.", 
        'warning');
    
    setTimeout(() => {
        const alertBtns = document.querySelector('.alert-btns');
        alertBtns.innerHTML = `
            <button class="btn" onclick="closeAlert();">Annuler</button>
            <button class="btn btn-primary" onclick="closeAlert(); proceedWithRestart();">Recommencer</button>
        `;
    }, 100);
}

function proceedWithRestart() {
    // 完全重新初始化
    currentQuestionIndex = 0;
    answeredQuestions.clear();
    currentAnswerSubmitted = false;
    
    document.getElementById('resultsContainer').classList.remove('show');
    document.getElementById('questionReview').classList.remove('active');
    document.getElementById('testContainer').style.display = 'block';
    
    // 重新选择题目
    selectQuestionsByTheme();
    userAnswers = new Array(selectedQuestions.length).fill(null);
    
    document.getElementById('totalQuestions').textContent = selectedQuestions.length;
    
    showQuestion(currentQuestionIndex);
    updateQuestionCounter();
    
    window.scrollTo(0, 0);
}

function showInstructions() {
    showAlert("Instructions du test",
        "TEST DES VALEURS RÉPUBLICAINES ET LAÏCITÉ\n\n" +
        "1. 20 questions à choix multiples\n" +
        "2. Pas de limite de temps\n" +
        "3. Cliquez sur une réponse pour la sélectionner\n" +
        "4. Cliquez sur 'Valider la réponse' pour voir la correction\n" +
        "5. Utilisez le bouton 'Question suivante' pour continuer\n" +
        "6. Cliquez sur 'Terminer le test' quand vous avez fini\n" +
        "7. Seuil de réussite : 16/20 (80%)\n\n" +
        "Bonne chance!", 'info');
}

function goBackToHome() {
    showAlert("Quitter le test", 
        "Êtes-vous sûr de vouloir quitter? Votre progression sera perdue.", 
        'warning');
    
    setTimeout(() => {
        const alertBtns = document.querySelector('.alert-btns');
        alertBtns.innerHTML = `
            <button class="btn" onclick="closeAlert();">Annuler</button>
            <button class="btn btn-primary" onclick="window.location.href='index.html';">Quitter</button>
        `;
    }, 100);
}

// ==================== 导航函数 ====================
function nextQuestion() {
    if (currentQuestionIndex < selectedQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
        updateQuestionCounter();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
        updateQuestionCounter();
    }
}

function updateQuestionCounter() {
    const answeredCount = answeredQuestions.size;
    const answeredPercent = Math.round((answeredCount / selectedQuestions.length) * 100);
    
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    document.getElementById('progressPercent').textContent = answeredPercent + '%';
    document.getElementById('progressFill').style.width = answeredPercent + '%';
}

function updateNavigationButtons() {
    document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
}

// ==================== 初始化 ====================
function initializeTest() {
    // 重置所有状态
    currentQuestionIndex = 0;
    userAnswers = [];
    answeredQuestions.clear();
    currentAnswerSubmitted = false;
    
    // 根据主题分布选择题目
    selectQuestionsByTheme();
    
    // 初始化用户答案数组
    userAnswers = new Array(selectedQuestions.length).fill(null);
    
    // 更新界面
    document.getElementById('totalQuestions').textContent = selectedQuestions.length;
    
    showQuestion(currentQuestionIndex);
    updateQuestionCounter();
    
    window.scrollTo(0, 0);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成");
    
    // 在登录页面按Enter键提交
    document.getElementById('studentPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            validateLogin();
        }
    });
});
</script>
</body>
</html>